services:

  # ── FastAPI scraper + search (private) ───────────────────────────────────
  api:
    build:
      context: ./api
    volumes:
      - ./scraped:/app/scraped       # scraped data persists on host
    environment:
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      SCRAPE_INTERVAL: "3600"
      SCRAPE_WORKERS: "10"

  # ── Express API + SQLite (private) ───────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    volumes:
      - backend_db:/data             # SQLite DB persists across restarts
    environment:
      PORT: "3001"
      NODE_ENV: production
      DB_PATH: /data/gather.db
      EVENTS_API_URL: http://api:8000/events
      FASTAPI_URL: http://api:8000
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-change-me}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
    depends_on:
      - api

  # ── nginx: serves React + proxies /api to backend (public) ──────────────
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    ports:
      - "80:80"
    environment:
      BACKEND_URL: http://backend:3001
    depends_on:
      - backend

volumes:
  backend_db:
